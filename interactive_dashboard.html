<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive NLP Analysis Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #FDFBF7;
            color: #4A4A4A;
        }
        .chart-container { position: relative; width: 100%; max-width: 800px; margin: auto; height: 350px; }
        .donut-chart-container { position: relative; width: 100%; max-width: 150px; height: 150px; margin: 0 auto; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #4f46e5; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <!-- Main Layout Container -->
    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        
        <!-- Header with Navigation -->
        <header class="flex justify-between items-center mb-8">
            <div>
                <h1 class="text-3xl font-bold text-indigo-700">News Analysis Dashboard</h1>
                <p class="text-md text-gray-600">Explore insights from the latest news</p>
            </div>
            <nav class="flex items-center space-x-4">
                <a href="{{ url_for('profile') }}" class="text-gray-600 hover:text-indigo-600 font-medium">Profile</a>
                <a href="{{ url_for('logout') }}" class="bg-indigo-100 text-indigo-700 hover:bg-indigo-200 font-semibold py-2 px-4 rounded-lg transition">Logout</a>
            </nav>
        </header>

        <!-- Main Content -->
        <main id="app-content">
            <!-- Search and Intro Section -->
            <section id="search-section" class="bg-white p-6 sm:p-8 rounded-xl shadow-md border border-gray-200 mb-8">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">Analyze a News Topic</h2>
                <p class="text-gray-600 mb-6">Enter a keyword to search for specific articles, or view the most recently published news.</p>
                <form id="search-form" class="flex flex-col sm:flex-row gap-4">
                    <input type="text" id="search-keyword" placeholder="Enter a topic (e.g., 'Quantum Computing')" class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 transition">
                    <button type="submit" id="search-button" class="bg-indigo-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-indigo-700 transition-colors flex items-center justify-center">
                        <span>Search</span>
                    </button>
                    <button type="button" id="latest-button" class="bg-gray-200 text-gray-800 font-semibold py-3 px-6 rounded-lg hover:bg-gray-300 transition-colors flex items-center justify-center">
                        <span>Latest News</span>
                    </button>
                </form>
                <div id="error-message" class="text-red-600 mt-4 hidden"></div>
            </section>

            <!-- Loading State -->
            <div id="loading-state" class="text-center py-10 hidden">
                <div class="loader inline-block"></div>
                <p class="mt-4 text-gray-600">Analyzing articles...</p>
            </div>

            <!-- Container for Latest News -->
            <section id="latest-section" class="hidden">
                <h2 class="text-3xl font-bold text-gray-800 mb-6">Latest News</h2>
                <!-- Dashboard content will be injected here by JS -->
            </section>

            <!-- Container for Search Results -->
            <section id="search-results-section" class="hidden">
                <h2 class="text-3xl font-bold text-gray-800 mb-6">Search Results</h2>
                <!-- Dashboard content will be injected here by JS -->
            </section>
        </main>
    </div>

    <!-- Reusable Template for Dashboard View -->
    <template id="dashboard-template">
        <div class="dashboard-view">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="bg-white p-6 rounded-xl shadow-md border"><h3 class="text-lg font-semibold text-gray-500">Current View</h3><p class="metric-topic text-3xl font-bold text-indigo-600">-</p></div>
                <div class="bg-white p-6 rounded-xl shadow-md border"><h3 class="text-lg font-semibold text-gray-500">Total Articles</h3><p class="metric-total-articles text-3xl font-bold text-indigo-600">0</p></div>
                <div class="bg-white p-6 rounded-xl shadow-md border"><h3 class="text-lg font-semibold text-gray-500">Overall Sentiment</h3><p class="metric-overall-sentiment text-3xl font-bold text-gray-700">-</p></div>
            </div>
            <div class="bg-white p-6 sm:p-8 rounded-xl shadow-md border mb-8">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4 text-center">Sentiment Distribution</h2>
                <div class="chart-container"><canvas class="sentiment-bar-chart"></canvas></div>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-md border">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-4">Article Results</h2>
                    <div class="article-list space-y-3 max-h-[600px] overflow-y-auto pr-2"></div>
                </div>
                <div class="lg:col-span-2 bg-white p-6 sm:p-8 rounded-xl shadow-md border">
                    <div class="analysis-placeholder text-center py-20"><p class="text-gray-500 text-lg">Select an article to see its analysis.</p></div>
                    <div class="analysis-content hidden">
                        <h2 class="article-title text-2xl font-bold text-gray-900 mb-2"></h2>
                        <!-- *** NEW: Element for publication time *** -->
                        <p class="article-time text-sm text-gray-500 mb-4"></p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <div class="bg-gray-50 p-4 rounded-lg border">
                                <h3 class="font-semibold text-lg mb-2 text-center">Sentiment Analysis</h3>
                                <div class="donut-chart-container"><canvas class="sentiment-donut-chart"></canvas></div>
                                <p class="sentiment-label text-2xl font-bold text-center mt-2"></p>
                            </div>
                            <div class="bg-gray-50 p-4 rounded-lg border">
                                <h3 class="font-semibold text-lg mb-3">Named Entities</h3>
                                <div class="ner-tags space-y-3"></div>
                            </div>
                        </div>
                        <div>
                            <h3 class="font-semibold text-lg mb-2">Article Content</h3>
                            <p class="article-content text-gray-700 leading-relaxed max-h-60 overflow-y-auto pr-2"></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const searchForm = document.getElementById('search-form');
            const latestButton = document.getElementById('latest-button');
            const errorMessage = document.getElementById('error-message');
            const loadingState = document.getElementById('loading-state');
            
            const latestSection = document.getElementById('latest-section');
            const searchResultsSection = document.getElementById('search-results-section');
            const dashboardTemplate = document.getElementById('dashboard-template');

            let charts = {};

            // *** NEW: Helper function to format date ***
            const formatDate = (isoString) => {
                if (!isoString) return 'No date available';
                const date = new Date(isoString);
                return date.toLocaleString(undefined, {
                    year: 'numeric', month: 'long', day: 'numeric',
                    hour: 'numeric', minute: '2-digit'
                });
            };

            const setLoadingState = (isLoading) => {
                loadingState.classList.toggle('hidden', !isLoading);
                if (isLoading) {
                    latestSection.classList.add('hidden');
                    searchResultsSection.classList.add('hidden');
                    errorMessage.classList.add('hidden');
                }
            };

            const fetchData = async (url, viewName, targetSection) => {
                setLoadingState(true);
                try {
                    const fullUrl = `${window.location.origin}${url}`;
                    const response = await fetch(fullUrl);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const data = await response.json();
                    if (data.error) throw new Error(data.error);
                    
                    displayDataInView(data, viewName, targetSection);

                } catch (error) {
                    console.error("Fetch error:", error);
                    errorMessage.textContent = `Error: ${error.message}. Please try again.`;
                    errorMessage.classList.remove('hidden');
                } finally {
                    setLoadingState(false);
                }
            };
            
            const displayDataInView = (articlesData, viewName, targetSection) => {
                if (targetSection === latestSection) {
                    searchResultsSection.classList.add('hidden');
                } else {
                    latestSection.classList.add('hidden');
                }

                const viewClone = dashboardTemplate.content.cloneNode(true);
                targetSection.innerHTML = '';
                targetSection.appendChild(viewClone);
                targetSection.classList.remove('hidden');

                const view = targetSection.querySelector('.dashboard-view');
                
                updateDashboardMetrics(view, articlesData, viewName);
                renderArticleList(view, articlesData);
                renderSentimentBarChart(view, articlesData);
            };

            fetchData('/api/latest', 'Latest News', latestSection);

            searchForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const keyword = document.getElementById('search-keyword').value;
                if (!keyword) return;
                fetchData(`/api/analyze?keyword=${encodeURIComponent(keyword)}`, keyword, searchResultsSection);
            });
            
            latestButton.addEventListener('click', () => {
                searchResultsSection.classList.add('hidden');
                latestSection.classList.remove('hidden');
            });

            function updateDashboardMetrics(view, articlesData, viewName) {
                view.querySelector('.metric-topic').textContent = viewName;
                view.querySelector('.metric-total-articles').textContent = articlesData.length;
                
                const positiveCount = articlesData.filter(a => a.sentiment.label === 'POSITIVE').length;
                const negativeCount = articlesData.filter(a => a.sentiment.label === 'NEGATIVE').length;
                let overallSentiment = 'NEUTRAL';
                if (positiveCount > negativeCount * 1.2) overallSentiment = 'POSITIVE';
                if (negativeCount > positiveCount * 1.2) overallSentiment = 'NEGATIVE';
                view.querySelector('.metric-overall-sentiment').textContent = overallSentiment;
            }

            function renderArticleList(view, articlesData) {
                const articleList = view.querySelector('.article-list');
                articleList.innerHTML = '';
                if (articlesData.length === 0) {
                    articleList.innerHTML = '<p class="text-gray-500">No articles found.</p>';
                    return;
                }
                articlesData.forEach(article => {
                    const sentimentColor = article.sentiment.label === 'POSITIVE' ? 'green' : (article.sentiment.label === 'NEGATIVE' ? 'red' : 'gray');
                    const item = document.createElement('div');
                    item.className = 'p-3 border rounded-lg cursor-pointer hover:bg-indigo-50 hover:border-indigo-400 transition article-item';
                    item.addEventListener('click', () => {
                        view.querySelectorAll('.article-item').forEach(el => el.classList.remove('bg-indigo-100', 'border-indigo-500'));
                        item.classList.add('bg-indigo-100', 'border-indigo-500');
                        displayArticleAnalysis(view, articlesData, article.id);
                    });
                    // *** UPDATED: Added publication time to article list item ***
                    item.innerHTML = `
                        <h4 class="font-semibold text-gray-800">${article.title}</h4>
                        <p class="text-xs text-gray-500 mt-1">${formatDate(article.published_at)}</p>
                        <div class="flex items-center mt-2">
                            <span class="w-3 h-3 rounded-full bg-${sentimentColor}-500 mr-2"></span>
                            <span class="text-sm font-medium text-${sentimentColor}-600">${article.sentiment.label}</span>
                        </div>
                    `;
                    articleList.appendChild(item);
                });
            }

            function displayArticleAnalysis(view, articlesData, id) {
                const article = articlesData.find(a => a.id === id);
                if (!article) return;

                view.querySelector('.analysis-placeholder').classList.add('hidden');
                const analysisContent = view.querySelector('.analysis-content');
                analysisContent.classList.remove('hidden');

                analysisContent.querySelector('.article-title').textContent = article.title;
                // *** UPDATED: Display publication time in detailed view ***
                analysisContent.querySelector('.article-time').textContent = `Published: ${formatDate(article.published_at)}`;
                analysisContent.querySelector('.article-content').textContent = article.content;
                
                const sentimentLabelEl = analysisContent.querySelector('.sentiment-label');
                sentimentLabelEl.textContent = article.sentiment.label;
                sentimentLabelEl.className = 'sentiment-label text-2xl font-bold text-center mt-2';
                if (article.sentiment.label === 'POSITIVE') sentimentLabelEl.classList.add('text-green-600');
                else if (article.sentiment.label === 'NEGATIVE') sentimentLabelEl.classList.add('text-red-600');
                else sentimentLabelEl.classList.add('text-gray-600');

                renderSentimentDonutChart(analysisContent, article.sentiment);
                renderNerTags(analysisContent, article.entities);
            }
            
            function renderNerTags(view, entities) {
                const container = view.querySelector('.ner-tags');
                container.innerHTML = '';
                const entityTypes = [
                    { key: 'PERSON', name: 'People', color: 'blue' },
                    { key: 'ORG', name: 'Organizations', color: 'purple' },
                    { key: 'GPE', name: 'Locations', color: 'yellow' }
                ];
                let contentRendered = false;
                entityTypes.forEach(type => {
                    if (entities[type.key] && entities[type.key].length > 0) {
                        contentRendered = true;
                        const div = document.createElement('div');
                        let tagsHtml = entities[type.key].map(entity => 
                            `<span class="inline-block bg-${type.color}-100 text-${type.color}-800 text-sm font-medium mr-2 mb-2 px-2.5 py-0.5 rounded">${entity}</span>`
                        ).join('');
                        div.innerHTML = `<h4 class="font-medium text-gray-700 mb-1">${type.name}:</h4><div>${tagsHtml}</div>`;
                        container.appendChild(div);
                    }
                });
                if (!contentRendered) {
                    container.innerHTML = '<p class="text-gray-500">No specific entities identified.</p>';
                }
            }

            function renderSentimentBarChart(view, articlesData) {
                const ctx = view.querySelector('.sentiment-bar-chart').getContext('2d');
                const chartId = 'barChart-' + view.parentElement.id;
                if (charts[chartId]) charts[chartId].destroy();
                
                const sentimentCounts = articlesData.reduce((acc, article) => {
                    acc[article.sentiment.label] = (acc[article.sentiment.label] || 0) + 1;
                    return acc;
                }, {});
                charts[chartId] = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['POSITIVE', 'NEGATIVE', 'NEUTRAL'],
                        datasets: [{
                            label: 'Number of Articles',
                            data: [sentimentCounts['POSITIVE'] || 0, sentimentCounts['NEGATIVE'] || 0, sentimentCounts['NEUTRAL'] || 0],
                            backgroundColor: ['rgba(22, 163, 74, 0.6)', 'rgba(220, 38, 38, 0.6)', 'rgba(107, 114, 128, 0.6)'],
                            borderColor: ['#16A34A', '#DC2626', '#6B7280'],
                            borderWidth: 1
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }, plugins: { legend: { display: false } } }
                });
            }

            function renderSentimentDonutChart(view, sentiment) {
                const ctx = view.querySelector('.sentiment-donut-chart').getContext('2d');
                const chartId = 'donutChart-' + view.parentElement.id;
                if (charts[chartId]) charts[chartId].destroy();

                const score = sentiment.score || 0;
                let data = [score, 1 - score];
                let colors = sentiment.label === 'POSITIVE' ? ['#16A34A', '#D1FAE5'] : (sentiment.label === 'NEGATIVE' ? ['#DC2626', '#FEE2E2'] : ['#6B7280', '#E5E7EB']);
                charts[chartId] = new Chart(ctx, {
                    type: 'doughnut',
                    data: { datasets: [{ data, backgroundColor: colors, borderWidth: 0 }] },
                    options: { responsive: true, maintainAspectRatio: false, cutout: '70%', plugins: { tooltip: { enabled: false } } }
                });
            }
        });
    </script>
</body>
</html>
